# ===========================================
# TRAEFIK DYNAMIC CONFIGURATION
# Defines routers for static services (API, Frontend)
# Container deployments get routers via Docker labels
# ===========================================

http:
  routers:
    # Zyphron API Router
    api-router:
      rule: "Host(`api.localhost`) || PathPrefix(`/api`)"
      service: api-service
      entryPoints:
        - web
      
    # Zyphron Frontend Router
    frontend-router:
      rule: "Host(`localhost`) || Host(`app.localhost`)"
      service: frontend-service
      entryPoints:
        - web

    # Catch-all for deployed apps (*.localhost)
    # Individual apps get their own routers via Docker labels
    
  services:
    # API Service
    api-service:
      loadBalancer:
        servers:
          - url: "http://zyphron-api:3000"
        healthCheck:
          path: /health
          interval: 10s
          timeout: 3s

    # Frontend Service  
    frontend-service:
      loadBalancer:
        servers:
          - url: "http://zyphron-frontend:3000"

  middlewares:
    # Rate Limiting
    rate-limit:
      rateLimit:
        average: 100
        burst: 50

    # Add security headers
    security-headers:
      headers:
        customResponseHeaders:
          X-Frame-Options: "SAMEORIGIN"
          X-Content-Type-Options: "nosniff"
          X-XSS-Protection: "1; mode=block"
          Referrer-Policy: "strict-origin-when-cross-origin"

    # CORS for API
    api-cors:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        accessControlAllowHeaders:
          - Content-Type
          - Authorization
          - X-Requested-With
        accessControlAllowOriginList:
          - "http://localhost:3001"
          - "http://app.localhost"
        accessControlMaxAge: 86400
        addVaryHeader: true
